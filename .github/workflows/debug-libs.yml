name: Debug Android Libraries

on:
  workflow_dispatch:

jobs:
  debug-libs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install tree and file
        run: |
          sudo apt update
          sudo apt install tree file -y

      - name: Prepare log file
        run: |
          echo "=== Android Library Debug Log $(date) ===" > debug.log

      - name: Show NDK environment
        run: |
          echo "## ðŸ” NDK Environment" | tee -a debug.log
          echo "ANDROID_NDK_LATEST_HOME: $ANDROID_NDK_LATEST_HOME" | tee -a debug.log
          echo "" | tee -a debug.log
          ls -la $ANDROID_NDK_LATEST_HOME >> debug.log 2>&1 || echo "NDK not found" >> debug.log

      - name: Find all Android libraries
        run: |
          echo "## ðŸ“š Android Libraries" | tee -a debug.log
          echo "" | tee -a debug.log
          
          LIBS=("liblog.so" "libandroid.so" "libsync.so" "libnativewindow.so" "libvulkan.so")
          
          for lib in "${LIBS[@]}"; do
            echo "### Searching for $lib" | tee -a debug.log
            find "$ANDROID_NDK_LATEST_HOME" -name "$lib" 2>/dev/null | while read path; do
              echo "- \`$path\`" | tee -a debug.log
              file "$path" >> debug.log 2>&1
            done
            echo "" | tee -a debug.log
          done

      - name: Find all Android headers
        run: |
          echo "## ðŸ“ Android Headers" | tee -a debug.log
          echo "" | tee -a debug.log
          
          HEADERS=(
            "android/hardware_buffer.h"
            "sync/sync.h"
            "android/log.h"
            "sys/cdefs.h"
            "cutils/native_handle.h"
          )
          
          for header in "${HEADERS[@]}"; do
            echo "### Searching for $header" | tee -a debug.log
            find "$ANDROID_NDK_LATEST_HOME" -path "*/$header" 2>/dev/null | while read path; do
              echo "- \`$path\`" | tee -a debug.log
            done
            if [ $? -ne 0 ]; then
              echo "  âŒ Not found" | tee -a debug.log
            fi
            echo "" | tee -a debug.log
          done

      - name: Show platform library directories
        run: |
          echo "## ðŸ—‚ï¸ Platform Library Directories" | tee -a debug.log
          echo "" | tee -a debug.log
          
          for api in 24 29 30 33 34; do
            for arch in aarch64-linux-android arm-linux-androideabi x86_64-linux-android; do
              LIB_PATH="$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/$arch/$api"
              if [ -d "$LIB_PATH" ]; then
                echo "### $arch API $api" | tee -a debug.log
                echo "\`$LIB_PATH\`" | tee -a debug.log
                ls -1 "$LIB_PATH" | grep -E "\.(so|a)$" | head -10 >> debug.log
                echo "... (truncated)" | tee -a debug.log
                echo "" | tee -a debug.log
              fi
            done
          done

      - name: Check CMake configuration
        run: |
          echo "## âš™ï¸ CMake Configuration Tips" | tee -a debug.log
          echo "" | tee -a debug.log
          echo "åœ¨ CMake ä¸­æŸ¥æ‰¾åº“çš„å¸¸ç”¨å‘½ä»¤ :" | tee -a debug.log
          echo '```cmake' >> debug.log
          echo '# find_library ä¼šè‡ªåŠ¨æœç´¢ NDK é¢„è®¾ç›®å½• ' >> debug.log
          echo 'find_library(log-lib log)' >> debug.log
          echo 'find_library(android-lib android)' >> debug.log
          echo 'find_library(sync-lib sync)' >> debug.log
          echo 'find_library(nativewindow-lib nativewindow)' >> debug.log
          echo '' >> debug.log
          echo '# é“¾æŽ¥åº“' >> debug.log
          echo 'target_link_libraries(your_target' >> debug.log
          echo '    ${log-lib}' >> debug.log
          echo '    ${android-lib}' >> debug.log
          echo '    ${sync-lib}' >> debug.log
          echo '    ${nativewindow-lib}' >> debug.log
          echo ')' >> debug.log
          echo '```' >> debug.log
          echo "" | tee -a debug.log
          
          echo "CMake 3.24+ æ”¯æŒ FindJNI æ¨¡å—æŸ¥æ‰¾ Android NDK åº“ :" | tee -a debug.log
          echo '```cmake' >> debug.log
          echo 'find_package(JNI REQUIRED COMPONENTS NativeHelper)' >> debug.log
          echo 'target_link_libraries(your_target PRIVATE JNI::NativeHelper)' >> debug.log
          echo '```' >> debug.log
          echo "" | tee -a debug.log

      - name: Generate search commands
        run: |
          echo "## ðŸ”Ž Quick Search Commands" | tee -a debug.log
          echo "" | tee -a debug.log
          echo "å¦‚æžœæƒ³æ‰‹åŠ¨æŸ¥æ‰¾ç‰¹å®šåº“:" | tee -a debug.log
          echo '```bash' >> debug.log
          echo '# æŸ¥æ‰¾åº“æ–‡ä»¶' >> debug.log
          echo 'find "$ANDROID_NDK_LATEST_HOME" -name "lib*.so" | grep -E "sync|nativewindow|hardware"' >> debug.log
          echo '' >> debug.log
          echo '# æŸ¥æ‰¾å¤´æ–‡ä»¶' >> debug.log
          echo 'find "$ANDROID_NDK_LATEST_HOME" -name "*.h" | grep -E "sync|hardware_buffer"' >> debug.log
          echo '' >> debug.log
          echo '# æŸ¥çœ‹é“¾æŽ¥å™¨æœç´¢è·¯å¾„' >> debug.log
          echo '$CC -print-search-dirs' >> debug.log
          echo '```' >> debug.log

      - name: Upload debug log
        uses: actions/upload-artifact@v4
        with:
          name: android-library-debug-log
          path: debug.log