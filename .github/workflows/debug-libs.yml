name: Debug Android Libraries

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  debug-libs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install tree and file
        run: |
          sudo apt update
          sudo apt install tree file -y

      - name: Show NDK environment
        run: |
          echo "## ðŸ” NDK Environment" >> $GITHUB_STEP_SUMMARY
          echo "ANDROID_NDK_LATEST_HOME: $ANDROID_NDK_LATEST_HOME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -la $ANDROID_NDK_LATEST_HOME || echo "NDK not found"

      - name: Find all Android libraries
        run: |
          echo "## ðŸ“š Android Libraries" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾å…³é”®åº“æ–‡ä»¶
          LIBS=("liblog.so" "libandroid.so" "libsync.so" "libnativewindow.so" "libvulkan.so")
          
          for lib in "${LIBS[@]}"; do
            echo "### Searching for $lib" >> $GITHUB_STEP_SUMMARY
            find "$ANDROID_NDK_LATEST_HOME" -name "$lib" 2>/dev/null | while read path; do
              echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
              file "$path" >> $GITHUB_STEP_SUMMARY
            done
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Find all Android headers
        run: |
          echo "## ðŸ“ Android Headers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æŸ¥æ‰¾å…³é”®å¤´æ–‡ä»¶
          HEADERS=(
            "android/hardware_buffer.h"
            "sync/sync.h"
            "android/log.h"
            "sys/cdefs.h"
            "cutils/native_handle.h"
          )
          
          for header in "${HEADERS[@]}"; do
            echo "### Searching for $header" >> $GITHUB_STEP_SUMMARY
            find "$ANDROID_NDK_LATEST_HOME" -path "*/$header" 2>/dev/null | while read path; do
              echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
            done
            if [ $? -ne 0 ]; then
              echo "  âŒ Not found" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Show platform library directories
        run: |
          echo "## ðŸ—‚ï¸ Platform Library Directories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # åˆ—å‡ºå„ API ç‰ˆæœ¬çš„åº“ç›®å½• [citation:1][citation:2]
          for api in 24 29 30 33 34; do
            for arch in aarch64-linux-android arm-linux-androideabi x86_64-linux-android; do
              LIB_PATH="$ANDROID_NDK_LATEST_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/$arch/$api"
              if [ -d "$LIB_PATH" ]; then
                echo "### $arch API $api" >> $GITHUB_STEP_SUMMARY
                echo "\`$LIB_PATH\`" >> $GITHUB_STEP_SUMMARY
                ls -1 "$LIB_PATH" | grep -E "\.(so|a)$" | head -10 >> $GITHUB_STEP_SUMMARY
                echo "... (truncated)" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done

      - name: Check CMake configuration
        run: |
          echo "## âš™ï¸ CMake Configuration Tips" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "åœ¨ CMake ä¸­æŸ¥æ‰¾åº“çš„å¸¸ç”¨å‘½ä»¤ [citation:1]:" >> $GITHUB_STEP_SUMMARY
          echo '```cmake' >> $GITHUB_STEP_SUMMARY
          echo '# find_library ä¼šè‡ªåŠ¨æœç´¢ NDK é¢„è®¾ç›®å½• [citation:1]' >> $GITHUB_STEP_SUMMARY
          echo 'find_library(log-lib log)' >> $GITHUB_STEP_SUMMARY
          echo 'find_library(android-lib android)' >> $GITHUB_STEP_SUMMARY
          echo 'find_library(sync-lib sync)' >> $GITHUB_STEP_SUMMARY
          echo 'find_library(nativewindow-lib nativewindow)' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# é“¾æŽ¥åº“' >> $GITHUB_STEP_SUMMARY
          echo 'target_link_libraries(your_target' >> $GITHUB_STEP_SUMMARY
          echo '    ${log-lib}' >> $GITHUB_STEP_SUMMARY
          echo '    ${android-lib}' >> $GITHUB_STEP_SUMMARY
          echo '    ${sync-lib}' >> $GITHUB_STEP_SUMMARY
          echo '    ${nativewindow-lib}' >> $GITHUB_STEP_SUMMARY
          echo ')' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "CMake 3.24+ æ”¯æŒ FindJNI æ¨¡å—æŸ¥æ‰¾ Android NDK åº“ [citation:9]:" >> $GITHUB_STEP_SUMMARY
          echo '```cmake' >> $GITHUB_STEP_SUMMARY
          echo 'find_package(JNI REQUIRED COMPONENTS NativeHelper)' >> $GITHUB_STEP_SUMMARY
          echo 'target_link_libraries(your_target PRIVATE JNI::NativeHelper)' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Generate search commands
        run: |
          echo "## ðŸ”Ž Quick Search Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœæƒ³æ‰‹åŠ¨æŸ¥æ‰¾ç‰¹å®šåº“:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo '# æŸ¥æ‰¾åº“æ–‡ä»¶' >> $GITHUB_STEP_SUMMARY
          echo 'find "$ANDROID_NDK_LATEST_HOME" -name "lib*.so" | grep -E "sync|nativewindow|hardware"' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# æŸ¥æ‰¾å¤´æ–‡ä»¶' >> $GITHUB_STEP_SUMMARY
          echo 'find "$ANDROID_NDK_LATEST_HOME" -name "*.h" | grep -E "sync|hardware_buffer"' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '# æŸ¥çœ‹é“¾æŽ¥å™¨æœç´¢è·¯å¾„' >> $GITHUB_STEP_SUMMARY
          echo '$CC -print-search-dirs' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload findings as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-library-debug
          path: ${{ github.workspace }}/*.log
          if-no-files-found: ignore
